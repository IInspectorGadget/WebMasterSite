<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Urls-Info</title>
    <link href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.css">
    <link href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.css">
</head>
<body>
<style>
    /* CSS стили для DataTables */
    table.dataTable {
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
    }

    table.dataTable thead th {
        border: 1px solid #ddd;
        /*padding: 8px;*/
        text-align: left;
    }

    table.dataTable tfoot th {
        border: 1px solid #ddd;
        /*padding: 8px;*/
        text-align: left;
    }

    table.dataTable tbody td {
        border: 1px solid #ddd;
        /*padding: 8px;*/
    }

    table.dataTable tbody tr:hover {
        background-color: #f5f5f5;
    }
</style>

<a href="/admin/info-urls"><h3 style="text-align: left">Таблица ссылок</h3></a>
<input type="date" id="start_date">
<input type="date" id="end_date">
<input type="text" id="search_field" style="width: 250px">
<label for="input_sort">Отсортировать?</label>
<input type="checkbox" id="input_sort">
<label for="input_desc">По убыванию?</label>
<input type="checkbox" id="input_desc">
<input type="button" value="Отфильтровать" onclick="UpdateTable();">
<table id="example" class="display nowrap" style="width:100%;">

    <thead>

    </thead>
    <tbody>

    </tbody>

</table>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script src="https://cdn.datatables.net/2.0.6/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>


<!--<script src="/static/assets/vendor/jquery/jquery-3.3.1.min.js"></script>-->

<script>
    function getDate(minus_day) {
        var today = new Date();
        var twoWeeksAgo = new Date(today.getTime() - (minus_day * 24 * 60 * 60 * 1000));
        var ddTwoWeeksAgo = String(twoWeeksAgo.getDate()).padStart(2, '0');
        var mmTwoWeeksAgo = String(twoWeeksAgo.getMonth() + 1).padStart(2, '0');
        var yyyyTwoWeeksAgo = twoWeeksAgo.getFullYear();

        var twoWeeksAgoDate = yyyyTwoWeeksAgo + '-' + mmTwoWeeksAgo + '-' + ddTwoWeeksAgo;
        return twoWeeksAgoDate
    }

    function IncrementDate(date, minus_day) {
        var today = new Date(date);
        var twoWeeksAgo = new Date(today.getTime() + (minus_day * 24 * 60 * 60 * 1000));
        var ddTwoWeeksAgo = String(twoWeeksAgo.getDate()).padStart(2, '0');
        var mmTwoWeeksAgo = String(twoWeeksAgo.getMonth() + 1).padStart(2, '0');
        var yyyyTwoWeeksAgo = twoWeeksAgo.getFullYear();

        var twoWeeksAgoDate = yyyyTwoWeeksAgo + '-' + mmTwoWeeksAgo + '-' + ddTwoWeeksAgo;
        return twoWeeksAgoDate
    }


    function calculateDays() {
        var start_date = new Date(document.getElementById('start_date').value);
        var end_date = new Date(document.getElementById('end_date').value);

        var diffTime = Math.abs(end_date - start_date);
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        return diffDays;
    }

    function SetDatePage() {
        // Set today date in the input for start date
        document.getElementById('end_date').value = getDate(0);

        // Set the default value of the second input to two weeks ago
        document.getElementById('start_date').value = getDate(14);
    }

    function SetDataTable() {

        columns = [
            {"title": "url"},
        ]

        amount = calculateDays();

        for (i = 0; i < amount; i++) {
            columns.push({"title": IncrementDate(document.getElementById('start_date').value, i)})
        }

        let table = $('#example').DataTable();


        table.destroy();

        table = new DataTable('#example', {
            // layout: {
            //     topStart: {
            //         buttons: ['csv', 'excel']
            //     }
            // },
            // "dom": '<"wrapper"lrtip>',
            dom: 'Brtip',
            buttons: [
                'csv', 'excel'
            ],
            "serverSide": true,
            "processing": true,
            "pageLength": 50,
            "columns": columns,
            deferRender: true,
            "ajax": {
                "url": "/admin/get-queries",
                "type": "POST",
                "data": function (d) {
                    d.length = d.length || 10; // количество отображаемых элементов
                    d.start = d.start || 0; // номер страницы
                    d.start_date = document.getElementById('start_date').value; // Дата начала поиска
                    d.end_date = document.getElementById('end_date').value; // Дата окончания поиска
                    d.amount = calculateDays();
                    d.search_text = document.getElementById("search_field").value;
                    d.sort_result = document.getElementById("input_sort").checked;
                    d.sort_desc = document.getElementById("input_desc").checked;
                }
            },

        });
    }

    function UpdateTable() {
        SetDataTable();
    }

    $(document).ready(SetDatePage())
    $(document).ready(SetDataTable())
</script>

</body>
</html>